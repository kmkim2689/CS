# 인터럽트 처리

## Intro

[3. 인터럽트 개요](https://github.com/kmkim2689/CS/blob/main/OS/3.%20%EC%9D%B8%ED%84%B0%EB%9F%BD%ED%8A%B8%20%EA%B0%9C%EC%9A%94.md)에서, 프로그램은 실행 중 어느 순간에나 **인터럽트가 발생하여도, 원래 연속적 코드로 실행된 것처럼 동작해야한다**는 점을 인지해야 한다고 기술한 바 있다. 이와 관련하여, **4. 인터럽트 처리**에서는 인터럽트의 발생시 사용자 프로그램에 영향을 주지 않도록 하기 위하여 컴퓨터에서는 어떠한 과정을 거치는가에 관하여 알아보고자 한다.

<br/>

## 인터럽트 처리 과정

* 인터럽트 처리 과정을 간단히 살펴보면 다음과 같다. 
> 주목할 만한 점은 하드웨어와 소프트웨어가 모두 인터럽트 처리 과정에 관여하며, 하드웨어에서 일어나는 일과 소프트웨어에서 일어나는 일이 구분되어 있다는 것이다. 하드웨어는 하드웨어의 회로가 인터럽트를 처리할 수 있도록 적절히 세팅하는 과정에 관여하고, 소프트웨어는 인터럽트 명령 수행 및 처리 후 작업에 관여한다.

![인터럽트 과정](https://user-images.githubusercontent.com/101035437/186325744-b191056e-6bdb-46e0-a16c-22ae73c2797b.png)

* 하드웨어에서

> 1. 장치 제어기나 다른 하드웨어(하드디스크, 프린터 등)에서 인터럽트가 발생하면, 처리기에 인터럽트의 발생을 알리기 위해 신호를 전송하는 과정이다. 이 과정은 명령어 반입과 명령어 수행 사이에서 발생한다.
> 
> 2. 각 명령어는 **원자적**으로 수행된다는 원칙에 따라, 수행중인 하나의 명령어는 온전히 수행이 완료됨을 보장받는다. 따라서 처리기는 현재 명령어의 처리를 일단 완료시킨다. 예를 들어, i번 주소의 명령어가 수행중이었다면 그 명령어는 수행을 마저 끝내게 된다.
> 
> 3. 처리기가 하드웨어로부터 인터럽트가 왔는지 확인한다.(회로에서 인터럽트가 온다면 레지스터에 앞에 1이 뜨도록 설정되어 있다.) 인터럽트가 왔음을 인지하게 된 처리기가 하드웨어에 인터럽트 확인 신호를 보냄으로써 하드웨어의 인터럽트 신호를 제거한다.
> 
> 4. 프로그램 수행 중 인터럽트가 발생해도, 원래 **연속적 코드로 실행된 것처럼 동작하도록 하는** 핵심 과정이다. 현재 **[PSW](https://en.wikipedia.org/wiki/Program_status_word)** (레지스터의 일종으로 메모리 사용 정보, 조건 코드, 인터럽트 허용 등 처리기의 특정 상태값들을 저장) 및 **PC**(i번지까지 완료했으니, 일반적으로는 i+1이 저장되어 있을 것)에 적재되어 있는 정보를 제어스택(운영체제가 사용하는 스택)에 저장한다.
> 
>     즉 처리기 안의 레지스터의 원래 값들을 다른 곳(제어 스택)에 저장해놓고, 
>     인터럽트가 끝나고 다른 곳에 저장해두던 값들을 다시 처리기에 복구함으로써 프로그램이 물 흐르듯 수행되도록 하기 위한 기초단계로 보면 좋다.
> 
> 5. 메모리에 적재되어 있는 인터럽트 처리 루틴 명령어들을 처리기가 수행하도록 해야 하는데, 이를 위해 처리기는 인터럽트 처리 루틴의 시작 주소에 해당하는 새로운 주소값을 PC에 적재한다.

* 소프트웨어에서

> 6. 프로세스의 나머지 상태정보를 저장한다. 상태정보란, 프로세스가 실행되는 중 처리기 내의 레지스터 값을 뜻한다. 앞서 4. 에서 PC랑 PSW는 이미 제어스택에 저장해 두었기 때문에, 나머지 상태정보들을 저장하고 있는 레지스터 값들을 제어스택에 마저 저장해놓는다. 4.와 마찬가지로 이 과정을 거치지 않으면 인터럽트 수행 종료 후 프로그램의 연속적 동작을 보장해줄 수 없다.
> 
> 7. 인터럽트 처리기가 인터럽트를 처리한다.
> 
> 8. 6.에서 제어스택에 저장해 두었던 레지스터 값들을 읽어 처리기의 레지스터들이 인터럽트 전 가지고 있던 값으로 돌려놓는다.
> 
> 9. 4.에서 저장해 두었던 PSW와 PC값을 복구한다.(PC값은 i+1로 복구)

<br/>

<br/>

## 출처 및 참고
* 학교 수업 내용
* William Stallings 저(전광일 등 역), 운영체제-내부구조 및 설계원리 제8판, 프로텍미디어.
